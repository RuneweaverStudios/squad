#!/bin/bash
# Get the session ID for the current Claude Code session
#
# Strategy: Walk up process tree to find Claude Code parent, then read its session file
# This provides true process isolation - each terminal gets its own session ID
#
# Usage: get-current-session-id [--wait]
#   --wait  Retry up to 5 times (1s apart) if session file not found yet.
#           Useful on fresh startup before the statusline has run.
#
# Returns: session ID (UUID) on stdout
# Exit code: 0 on success, 1 if no session file found

set -e

WAIT_MODE=false
if [[ "${1:-}" == "--wait" ]]; then
    WAIT_MODE=true
fi

# Function to find Claude Code parent process by walking up the tree
find_claude_ppid() {
    local current_pid=$$
    local max_depth=20
    local depth=0

    while [[ $depth -lt $max_depth ]]; do
        # Get parent PID
        local parent_pid=$(ps -o ppid= -p "$current_pid" 2>/dev/null | tr -d ' ')

        if [[ -z "$parent_pid" ]] || [[ "$parent_pid" == "1" ]]; then
            return 1
        fi

        # Get parent process name
        local parent_name=$(ps -o comm= -p "$parent_pid" 2>/dev/null)

        # Check if this is Claude Code (node process running claude)
        if [[ "$parent_name" =~ (node|claude) ]]; then
            # Check if session file exists for this PPID
            if [[ -f "/tmp/claude-session-${parent_pid}.txt" ]]; then
                echo "$parent_pid"
                return 0
            fi
        fi

        current_pid=$parent_pid
        ((depth++))
    done

    return 1
}

# Main lookup function - returns 0 on success, 1 on failure
# Sets session_id variable on success
try_find_session() {
    # Try to find Claude Code PPID
    local claude_ppid
    claude_ppid=$(find_claude_ppid) || true

    if [[ -z "$claude_ppid" ]]; then
        # Fallback: use most recent session file (old behavior)
        local session_file
        session_file=$(ls -t /tmp/claude-session-*.txt 2>/dev/null | head -1)

        if [[ -z "$session_file" ]] || [[ ! -f "$session_file" ]]; then
            return 1
        fi
    else
        local session_file="/tmp/claude-session-${claude_ppid}.txt"
    fi

    # Read the session ID
    session_id=$(cat "$session_file" 2>/dev/null | tr -d '\n')
    [[ -n "$session_id" ]]
}

# Try to find session, with optional retry
session_id=""
if try_find_session; then
    echo "$session_id"
    exit 0
fi

# If --wait mode, retry up to 5 times
if [[ "$WAIT_MODE" == true ]]; then
    for attempt in 1 2 3 4 5; do
        sleep 1
        if try_find_session; then
            echo "$session_id"
            exit 0
        fi
    done
fi

echo "Error: No Claude Code session file found in /tmp" >&2
echo "The statusline must run at least once to create the session file" >&2
echo "Hint: Use --wait to retry automatically on fresh startup" >&2
exit 1
