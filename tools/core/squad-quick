#!/bin/bash
# squad-quick - Execute a single-turn Claude command without a full agent session
#
# Usage:
#   squad-quick 'prompt'                    # Run with defaults (haiku model, current project)
#   squad-quick 'prompt' --project chimaro  # Run in specific project
#   squad-quick 'prompt' --model sonnet     # Use specific model
#   squad-quick --template my-template      # Run a saved template
#   echo 'prompt' | squad-quick             # Pipe from stdin
#
# Templates are stored in ~/.config/squad/quick-commands.json

set -euo pipefail

VERSION="0.1.0"
MODEL="haiku"
PROJECT=""
TEMPLATE=""
TIMEOUT="60"
PROMPT=""
VARIABLES=""

show_help() {
    cat <<'EOF'
squad-quick - Single-turn Claude command execution

USAGE:
  squad-quick 'prompt' [OPTIONS]
  squad-quick --template <name> [OPTIONS]
  echo 'prompt' | squad-quick [OPTIONS]

OPTIONS:
  -p, --project <name>     Project directory context (default: current dir's project)
  -m, --model <model>      Model to use: haiku, sonnet, opus (default: haiku)
  -t, --template <id>      Use a saved template by ID or name
  -v, --var <key=value>    Set template variable (repeatable)
  --timeout <seconds>      Timeout in seconds (default: 60)
  --list-templates         List saved templates
  --version                Show version
  -h, --help               Show this help

EXAMPLES:
  squad-quick 'What files handle authentication?'
  squad-quick 'Summarize recent changes' --project chimaro --model sonnet
  squad-quick --template code-review --var file=src/auth.ts
  echo 'Explain this error' | squad-quick

TEMPLATES:
  Templates are stored in ~/.config/squad/quick-commands.json
  Manage via the SQUAD IDE at /quick-commands
EOF
}

# Detect current project from git root or cwd
detect_project() {
    local git_root
    git_root=$(git rev-parse --show-toplevel 2>/dev/null) || true
    if [[ -n "$git_root" ]]; then
        basename "$git_root"
    else
        basename "$(pwd)"
    fi
}

# Load template by ID or name
load_template() {
    local search="$1"
    local templates_file="$HOME/.config/squad/quick-commands.json"

    if [[ ! -f "$templates_file" ]]; then
        echo "Error: No templates found. Create templates in the SQUAD IDE." >&2
        exit 1
    fi

    local template
    # Try ID match first, then name match (case-insensitive)
    template=$(jq -r --arg s "$search" '
        (.[] | select(.id == $s)) //
        (.[] | select(.name | ascii_downcase == ($s | ascii_downcase))) //
        empty
    ' "$templates_file" 2>/dev/null)

    if [[ -z "$template" ]]; then
        echo "Error: Template '$search' not found." >&2
        echo "Use --list-templates to see available templates." >&2
        exit 1
    fi

    echo "$template"
}

list_templates() {
    local templates_file="$HOME/.config/squad/quick-commands.json"

    if [[ ! -f "$templates_file" ]] || [[ ! -s "$templates_file" ]]; then
        echo "No templates saved yet."
        echo "Create templates in the SQUAD IDE at /quick-commands"
        exit 0
    fi

    echo "Saved templates:"
    echo ""
    jq -r '.[] | "  \(.id)  \(.name)  [\(.defaultModel // "haiku")]  \(.prompt[0:60])..."' "$templates_file"
}

# Parse arguments
declare -a VAR_ARGS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        --version)
            echo "squad-quick $VERSION"
            exit 0
            ;;
        -p|--project)
            PROJECT="$2"
            shift 2
            ;;
        -m|--model)
            MODEL="$2"
            shift 2
            ;;
        -t|--template)
            TEMPLATE="$2"
            shift 2
            ;;
        -v|--var)
            VAR_ARGS+=("$2")
            shift 2
            ;;
        --timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        --list-templates)
            list_templates
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage" >&2
            exit 1
            ;;
        *)
            PROMPT="$1"
            shift
            ;;
    esac
done

# Read from stdin if no prompt and not a template
if [[ -z "$PROMPT" ]] && [[ -z "$TEMPLATE" ]] && [[ ! -t 0 ]]; then
    PROMPT=$(cat)
fi

# Handle template mode
if [[ -n "$TEMPLATE" ]]; then
    tmpl_json=$(load_template "$TEMPLATE")
    PROMPT=$(echo "$tmpl_json" | jq -r '.prompt')

    # Use template defaults if not overridden
    if [[ -z "$PROJECT" ]]; then
        tmpl_project=$(echo "$tmpl_json" | jq -r '.defaultProject // empty')
        [[ -n "$tmpl_project" ]] && PROJECT="$tmpl_project"
    fi
    if [[ "$MODEL" == "haiku" ]]; then
        tmpl_model=$(echo "$tmpl_json" | jq -r '.defaultModel // empty')
        [[ -n "$tmpl_model" ]] && MODEL="$tmpl_model"
    fi

    # Apply variable substitutions
    for var_arg in "${VAR_ARGS[@]}"; do
        key="${var_arg%%=*}"
        value="${var_arg#*=}"
        PROMPT="${PROMPT//\{$key\}/$value}"
    done

    # Apply default values for unsubstituted variables
    while IFS= read -r var_json; do
        var_name=$(echo "$var_json" | jq -r '.name')
        var_default=$(echo "$var_json" | jq -r '.default // empty')
        if [[ -n "$var_default" ]]; then
            PROMPT="${PROMPT//\{$var_name\}/$var_default}"
        fi
    done < <(echo "$tmpl_json" | jq -c '.variables[]? // empty')
fi

# Validate we have a prompt
if [[ -z "$PROMPT" ]]; then
    echo "Error: No prompt provided." >&2
    echo "Usage: squad-quick 'your prompt' [--project X] [--model haiku]" >&2
    exit 1
fi

# Default project from current directory
if [[ -z "$PROJECT" ]]; then
    PROJECT=$(detect_project)
fi

# Execute via claude -p with stdin piping
echo "$PROMPT" | claude -p --model "$MODEL"
