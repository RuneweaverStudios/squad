#!/bin/bash

# JAT Demo Project Setup and Visibility Toggle
# Usage: jat-demo [setup|on|off|status|clean]

CONFIG_FILE="$HOME/.config/jat/projects.json"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Demo projects - updated to match new structure
DEMO_PROJECTS=("jat-demo-blog" "jat-demo-shop" "jat-demo-dashboard")
DEMO_DESCRIPTIONS=(
    "Blog platform demo"
    "E-commerce store demo"
    "Analytics dashboard demo"
)

show_usage() {
    echo "Usage: jat-demo [setup|on|off|status|clean]"
    echo "  setup  - Create demo projects and initialize with beads"
    echo "  on     - Show only demo projects in dashboard"
    echo "  off    - Hide demo projects, show regular projects"
    echo "  status - Show current visibility status"
    echo "  clean  - Remove all demo projects"
    echo ""
    echo "Quick start: jat-demo setup && jat-demo on"
}

check_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo -e "${RED}Error: Config file not found at $CONFIG_FILE${NC}"
        exit 1
    fi
}

set_visibility() {
    local visibility="$1"
    local temp_file="/tmp/jat-projects-$$.json"

    # Use jq to update visibility for all projects
    if [[ "$visibility" == "demo-only" ]]; then
        # Hide all non-demo projects, show demo projects
        jq '.projects |= with_entries(
            if (.key | test("^jat-demo-")) then
                .value.hidden = false
            else
                .value.hidden = true
            end
        )' "$CONFIG_FILE" > "$temp_file"
        echo -e "${GREEN}✓ Showing only demo projects${NC}"
    else
        # Show all non-demo projects, hide demo projects
        jq '.projects |= with_entries(
            if (.key | test("^jat-demo-")) then
                .value.hidden = true
            else
                .value.hidden = false
            end
        )' "$CONFIG_FILE" > "$temp_file"
        echo -e "${GREEN}✓ Hiding demo projects, showing regular projects${NC}"
    fi

    # Replace original file
    mv "$temp_file" "$CONFIG_FILE"
}

show_status() {
    echo -e "${BLUE}Project Visibility Status:${NC}"
    echo "----------------------------"

    # Show all projects with their visibility
    jq -r '.projects | to_entries[] |
        "\(.key): \(if .value.hidden == true then "❌ Hidden" else "✅ Visible" end)"' "$CONFIG_FILE" | \
    while IFS= read -r line; do
        if [[ "$line" == *"jat-demo-"* ]]; then
            echo -e "${BLUE}[DEMO] $line${NC}"
        else
            echo "       $line"
        fi
    done
}

setup_demo_projects() {
    echo -e "${BLUE}Setting up demo projects...${NC}"
    local created=0
    local skipped=0

    for i in "${!DEMO_PROJECTS[@]}"; do
        local project="${DEMO_PROJECTS[$i]}"
        local desc="${DEMO_DESCRIPTIONS[$i]}"
        local path="$HOME/code/$project"

        echo -e "\n${YELLOW}Checking $project...${NC}"

        # Check if project already exists
        if [[ -d "$path/.beads" ]]; then
            echo -e "  ${BLUE}→ Already exists, skipping creation${NC}"
            ((skipped++))
        else
            echo -e "  Creating new project..."
            mkdir -p "$path"
            cd "$path"
            # Use proper bd init with defaults (no -y flag)
            echo -e "Y\nY\nY\nY\n" | bd init >/dev/null 2>&1
            ((created++))
        fi

        # Always reset task list for demo
        echo "[]" > "$path/.beads/issues.jsonl"
        echo -e "  Cleared task list"

        # Determine color based on project type
        local color_active=""
        local color_inactive=""
        case "$project" in
            "jat-demo-shop")
                # Green for shop
                color_active="oklch(0.75 0.18 142)"
                color_inactive="oklch(0.60 0.15 145)"
                ;;
            "jat-demo-blog")
                # Red/Pink for blog
                color_active="oklch(0.65 0.18 10)"
                color_inactive="oklch(0.55 0.15 10)"
                ;;
            "jat-demo-dashboard")
                # Blue for dashboard
                color_active="oklch(0.70 0.18 230)"
                color_inactive="oklch(0.55 0.15 230)"
                ;;
        esac

        # Add to JAT config if not already there
        if ! jq -e ".projects.\"$project\"" "$CONFIG_FILE" >/dev/null 2>&1; then
            echo -e "  Adding to JAT config with distinct color..."
            local temp_file="/tmp/jat-config-$$.json"
            jq ".projects.\"$project\" = {
                \"name\": \"${project^^}\",
                \"path\": \"$path\",
                \"description\": \"$desc\",
                \"active_color\": \"$color_active\",
                \"inactive_color\": \"$color_inactive\"
            }" "$CONFIG_FILE" > "$temp_file"
            mv "$temp_file" "$CONFIG_FILE"
        else
            # Update existing config to add colors if missing
            echo -e "  Updating colors in JAT config..."
            local temp_file="/tmp/jat-config-$$.json"
            jq ".projects.\"$project\".active_color = \"$color_active\" |
                .projects.\"$project\".inactive_color = \"$color_inactive\"" "$CONFIG_FILE" > "$temp_file"
            mv "$temp_file" "$CONFIG_FILE"
        fi

        echo -e "  ${GREEN}✓ $project ready${NC}"
    done

    echo -e "\n${BLUE}Summary: $created created, $skipped existed${NC}"

    # Kill any existing demo sessions
    echo -e "\n${YELLOW}Cleaning up old sessions...${NC}"
    tmux ls 2>/dev/null | grep "jat-.*demo" | cut -d: -f1 | while read -r session; do
        tmux kill-session -t "$session" 2>/dev/null
        echo -e "  Killed session: $session"
    done

    echo -e "\n${GREEN}✅ Demo environment ready!${NC}"
    echo -e "${BLUE}Run 'jat-demo on' to show only demo projects${NC}"
}

clean_demo_projects() {
    echo -e "${YELLOW}⚠️  This will delete all demo projects and their data!${NC}"
    read -p "Are you sure? (y/N): " -n 1 -r
    echo

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled"
        return
    fi

    echo -e "${RED}Removing demo projects...${NC}"

    for project in "${DEMO_PROJECTS[@]}"; do
        local path="$HOME/code/$project"

        if [[ -d "$path" ]]; then
            echo -e "  Removing $path..."
            rm -rf "$path"
        fi

        # Remove from config
        if jq -e ".projects.\"$project\"" "$CONFIG_FILE" >/dev/null 2>&1; then
            echo -e "  Removing $project from config..."
            local temp_file="/tmp/jat-config-$$.json"
            jq "del(.projects.\"$project\")" "$CONFIG_FILE" > "$temp_file"
            mv "$temp_file" "$CONFIG_FILE"
        fi
    done

    echo -e "${GREEN}Demo projects cleaned up${NC}"
}

# Main logic
case "${1:-status}" in
    setup)
        setup_demo_projects
        ;;
    on)
        check_config
        echo -e "${BLUE}Setting demo mode ON...${NC}"
        set_visibility "demo-only"
        show_status
        echo -e "\n${GREEN}Ready for demo recording!${NC}"
        ;;
    off)
        check_config
        echo -e "${BLUE}Setting demo mode OFF...${NC}"
        set_visibility "regular"
        show_status
        echo -e "\n${GREEN}Back to regular projects${NC}"
        ;;
    status)
        check_config
        show_status
        ;;
    clean)
        clean_demo_projects
        ;;
    -h|--help|help)
        show_usage
        ;;
    *)
        echo -e "${RED}Invalid option: $1${NC}"
        show_usage
        exit 1
        ;;
esac