#!/usr/bin/env node

import { start, stop } from './lib/scheduler.js';
import { closeDb } from './lib/dedup.js';
import { loadConfig } from './lib/config.js';
import * as logger from './lib/logger.js';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log(`squad-ingest - Content ingestion daemon

Watches external sources (Telegram, Slack, RSS) and creates SQUAD tasks.

USAGE:
    squad-ingest                        Start daemon (all enabled sources)
    squad-ingest --source <id>          Poll single source only
    squad-ingest --dry-run              Show what would be created, don't create tasks
    squad-ingest --once                 Poll all sources once then exit
    squad-ingest --help                 Show this help

CONFIG:
    ~/.config/squad/integrations.json   Source configuration
    ~/.local/share/squad/ingest.db      Dedup database

SOURCES:
    telegram    Telegram Bot API (getUpdates polling)
    slack       Slack Web API (conversations.history)
    rss         RSS/Atom feed parsing

See also:
    squad-ingest-test     Dry-run tester for individual sources
    squad-ingest-status   Show source stats and poll history
    squad-ingest-server   Start as managed server (server-ingest tmux session)`);
  process.exit(0);
}

// Parse options
const sourceId = getArg('--source');
const dryRunMode = args.includes('--dry-run');
const once = args.includes('--once');

// Validate config before starting
try {
  const config = loadConfig();
  if (config.sources.length === 0) {
    logger.warn('No sources configured. Edit ~/.config/squad/integrations.json');
    process.exit(0);
  }
} catch (err) {
  logger.error(`Config error: ${err.message}`);
  process.exit(1);
}

// Graceful shutdown
async function shutdown() {
  await stop();
  closeDb();
  process.exit(0);
}

process.on('SIGINT', () => shutdown());
process.on('SIGTERM', () => shutdown());

// Start the daemon (async: discovers plugins before polling)
await start({ sourceId, dryRun: dryRunMode });

// If --once mode, poll then exit
if (once) {
  // Give sources time to poll (max 60s)
  setTimeout(() => {
    logger.info('--once mode: exiting after poll cycle');
    shutdown();
  }, 60000);
}

function getArg(flag) {
  const idx = args.indexOf(flag);
  if (idx === -1) return null;
  return args[idx + 1] || null;
}
