#!/bin/bash
#
# jat-secret - Retrieve secrets from JAT credentials store
#
# Usage:
#   jat-secret <key-name>           # Get secret value by name
#   jat-secret --list               # List all custom key names
#   jat-secret --export             # Output export statements for all keys
#   jat-secret --env <key-name>     # Get the env var name for a key
#   jat-secret --help               # Show this help
#
# Examples:
#   jat-secret stripe                # Outputs: sk_live_xxx...
#   jat-secret --env stripe          # Outputs: STRIPE_API_KEY
#   eval $(jat-secret --export)      # Load all keys as env vars
#   MY_VAR=$(jat-secret my-service)  # Use in scripts
#
# Security:
#   - Reads from ~/.config/jat/credentials.json
#   - Values are not logged or displayed in --list
#   - Use in subshells to avoid leaking to process environment
#

set -euo pipefail

CREDENTIALS_FILE="$HOME/.config/jat/credentials.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << 'EOF'
jat-secret - Retrieve secrets from JAT credentials store

USAGE:
    jat-secret <key-name>           Get secret value by name
    jat-secret --list               List all custom key names
    jat-secret --export             Output export statements for all keys
    jat-secret --env <key-name>     Get the env var name for a key
    jat-secret --help               Show this help

EXAMPLES:
    jat-secret stripe                  # Outputs: sk_live_xxx...
    jat-secret --env stripe            # Outputs: STRIPE_API_KEY
    eval $(jat-secret --export)        # Load all keys as env vars
    MY_VAR=$(jat-secret my-service)    # Use in scripts

BUILT-IN KEYS:
    You can also retrieve built-in API keys:
    jat-secret anthropic               # Anthropic API key
    jat-secret google                  # Google/Gemini API key
    jat-secret openai                  # OpenAI API key

NOTE:
    Configure custom keys via Settings -> API Keys in the IDE.
EOF
}

error() {
    echo -e "${RED}error:${NC} $1" >&2
    exit 1
}

# Check if credentials file exists
check_credentials() {
    if [[ ! -f "$CREDENTIALS_FILE" ]]; then
        error "Credentials file not found: $CREDENTIALS_FILE\nRun the IDE and configure keys in Settings -> API Keys"
    fi
}

# Get a custom API key value
get_custom_key() {
    local name="$1"
    check_credentials

    local value
    value=$(jq -r ".customApiKeys.\"$name\".value // empty" "$CREDENTIALS_FILE" 2>/dev/null)

    if [[ -z "$value" ]]; then
        # Try built-in API keys
        value=$(jq -r ".apiKeys.\"$name\".key // empty" "$CREDENTIALS_FILE" 2>/dev/null)
    fi

    if [[ -z "$value" ]]; then
        error "Key not found: $name\nUse 'jat-secret --list' to see available keys"
    fi

    echo "$value"
}

# Get env var name for a custom key
get_env_var() {
    local name="$1"
    check_credentials

    local env_var
    env_var=$(jq -r ".customApiKeys.\"$name\".envVar // empty" "$CREDENTIALS_FILE" 2>/dev/null)

    if [[ -z "$env_var" ]]; then
        # Fallback for built-in keys
        case "$name" in
            anthropic) echo "ANTHROPIC_API_KEY" ;;
            google) echo "GEMINI_API_KEY" ;;
            openai) echo "OPENAI_API_KEY" ;;
            *) error "Key not found: $name" ;;
        esac
        return
    fi

    echo "$env_var"
}

# List all custom key names
list_keys() {
    check_credentials

    echo "Built-in keys:"
    # Check which built-in keys are set
    for key in anthropic google openai; do
        if jq -e ".apiKeys.\"$key\".key" "$CREDENTIALS_FILE" >/dev/null 2>&1; then
            echo "  $key"
        fi
    done

    echo ""
    echo "Custom keys:"
    local custom_keys
    custom_keys=$(jq -r '.customApiKeys // {} | keys[]' "$CREDENTIALS_FILE" 2>/dev/null)

    if [[ -z "$custom_keys" ]]; then
        echo "  (none configured)"
    else
        while IFS= read -r key; do
            local env_var
            env_var=$(jq -r ".customApiKeys.\"$key\".envVar" "$CREDENTIALS_FILE")
            local desc
            desc=$(jq -r ".customApiKeys.\"$key\".description // \"\"" "$CREDENTIALS_FILE")
            if [[ -n "$desc" ]]; then
                echo "  $key ($env_var) - $desc"
            else
                echo "  $key ($env_var)"
            fi
        done <<< "$custom_keys"
    fi
}

# Export all custom keys as shell export statements
export_keys() {
    check_credentials

    # Export built-in keys
    for key in anthropic google openai; do
        local value
        value=$(jq -r ".apiKeys.\"$key\".key // empty" "$CREDENTIALS_FILE" 2>/dev/null)
        if [[ -n "$value" ]]; then
            local env_var
            case "$key" in
                anthropic) env_var="ANTHROPIC_API_KEY" ;;
                google) env_var="GEMINI_API_KEY" ;;
                openai) env_var="OPENAI_API_KEY" ;;
            esac
            # Escape single quotes
            local escaped_value="${value//\'/\'\\\'\'}"
            echo "export $env_var='$escaped_value'"
        fi
    done

    # Export custom keys
    local custom_keys
    custom_keys=$(jq -r '.customApiKeys // {} | keys[]' "$CREDENTIALS_FILE" 2>/dev/null)

    while IFS= read -r key; do
        [[ -z "$key" ]] && continue
        local env_var value
        env_var=$(jq -r ".customApiKeys.\"$key\".envVar" "$CREDENTIALS_FILE")
        value=$(jq -r ".customApiKeys.\"$key\".value" "$CREDENTIALS_FILE")
        # Escape single quotes
        local escaped_value="${value//\'/\'\\\'\'}"
        echo "export $env_var='$escaped_value'"
    done <<< "$custom_keys"
}

# Main
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --list|-l)
        list_keys
        ;;
    --export|-e)
        export_keys
        ;;
    --env)
        if [[ -z "${2:-}" ]]; then
            error "Usage: jat-secret --env <key-name>"
        fi
        get_env_var "$2"
        ;;
    "")
        error "Usage: jat-secret <key-name>\nUse --help for more options"
        ;;
    -*)
        error "Unknown option: $1\nUse --help for usage"
        ;;
    *)
        get_custom_key "$1"
        ;;
esac
