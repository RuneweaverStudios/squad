#!/bin/bash
# jat-doctor - Diagnose jat installation health
# Run this when jat features aren't working

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

pass() { echo -e "${GREEN}✓${NC} $1"; }
fail() { echo -e "${RED}✗${NC} $1"; ISSUES+=("$1"); }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }

ISSUES=()

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  jat Doctor Report"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Find JAT installation directory
JAT_DIR=""
if [[ -n "${JAT_INSTALL_DIR:-}" ]] && [[ -d "$JAT_INSTALL_DIR" ]]; then
    JAT_DIR="$JAT_INSTALL_DIR"
elif [[ -d "${XDG_DATA_HOME:-$HOME/.local/share}/jat" ]]; then
    JAT_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/jat"
elif [[ -f "$HOME/.config/jat/projects.json" ]]; then
    _jat_path=$(jq -r '.projects.jat.path // empty' "$HOME/.config/jat/projects.json" 2>/dev/null | sed "s|^~|$HOME|g")
    [[ -n "$_jat_path" ]] && [[ -d "$_jat_path" ]] && JAT_DIR="$_jat_path"
fi

# 1. Check jat repo
if [[ -n "$JAT_DIR" ]] && [[ -d "$JAT_DIR" ]]; then
    pass "jat repo exists ($JAT_DIR)"
else
    fail "jat repo missing - set \$JAT_INSTALL_DIR or add jat to ~/.config/jat/projects.json"
fi

# 2. Check shared docs
if [[ -n "$JAT_DIR" ]]; then
    SHARED_COUNT=$(ls "$JAT_DIR/shared/"*.md 2>/dev/null | wc -l)
    if [[ $SHARED_COUNT -ge 10 ]]; then
        pass "$SHARED_COUNT shared docs found"
    else
        fail "Only $SHARED_COUNT shared docs (expected 10+)"
    fi
else
    fail "Cannot check shared docs - JAT dir not found"
fi

# 3. Check statusline
if [[ -f ~/.claude/statusline.sh ]]; then
    pass "Statusline installed"
else
    fail "Statusline missing - run: setup-statusline-and-hooks.sh"
fi

# 4. Check agent commands
if [[ -d ~/.claude/commands/jat ]]; then
    CMD_COUNT=$(ls ~/.claude/commands/jat/*.md 2>/dev/null | wc -l)
    BROKEN=$(find ~/.claude/commands/jat -type l ! -exec test -e {} \; -print 2>/dev/null | wc -l)
    if [[ $BROKEN -gt 0 ]]; then
        warn "$CMD_COUNT commands installed ($BROKEN broken symlinks)"
        echo "    Broken symlinks:"
        find ~/.claude/commands/jat -type l ! -exec test -e {} \; -print 2>/dev/null | while read f; do
            echo "      - $(basename "$f")"
        done
        echo "    Fix: rm ~/.claude/commands/jat/*.md && ./install.sh (from JAT dir)"
    else
        pass "$CMD_COUNT agent commands installed"
    fi
else
    fail "Agent commands not installed - run: ./install.sh (from JAT dir)"
fi

# 5. Check core tools
echo ""
echo "Tools:"
TOOLS_OK=true
for tool in am-register am-inbox am-send jt jat-signal; do
    if command -v $tool &>/dev/null; then
        pass "$tool"
    else
        fail "$tool missing"
        TOOLS_OK=false
    fi
done

if [[ "$TOOLS_OK" == "false" ]]; then
    echo "    Fix: ./install.sh (from JAT dir)"
fi

# 6. Check tasks in current project
echo ""
echo "Current Project ($(basename "$PWD")):"
if [[ -d .jat ]]; then
    TASK_COUNT=$(jt list --json 2>/dev/null | jq length 2>/dev/null || echo "?")
    pass "Tasks initialized ($TASK_COUNT tasks)"
else
    warn "Tasks not initialized - run: jt init"
fi

# 7. Check CLAUDE.md imports
if [[ -f CLAUDE.md ]]; then
    # Check for jat shared imports (any path format)
    IMPORTS=$(grep -cE "^@.*/shared/" CLAUDE.md 2>/dev/null || echo "0")
    if [[ $IMPORTS -ge 5 ]]; then
        pass "CLAUDE.md has $IMPORTS jat imports"
    else
        warn "CLAUDE.md has only $IMPORTS jat imports (expected 5+)"
        echo "    Run setup-repos.sh to configure CLAUDE.md imports"
    fi
else
    warn "No CLAUDE.md in current directory"
fi

# Summary
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if [[ ${#ISSUES[@]} -eq 0 ]]; then
    echo -e "  STATUS: ${GREEN}HEALTHY${NC}"
else
    echo -e "  STATUS: ${RED}NEEDS REPAIR${NC} (${#ISSUES[@]} issues)"
fi
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
