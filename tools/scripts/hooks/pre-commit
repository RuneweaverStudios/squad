#!/bin/sh
#
# SQUAD pre-commit hook
#
# 1. Ensures agent is registered (prevents "Claude" orphan commits)
# 2. Legacy: Flushes st (SQUAD Tasks) changes to JSONL before commit (obsolete - SQUAD uses SQLite)
#
# Install: cp this file to .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or run: squad hooks [path]
#

# ============================================================
# AGENT REGISTRATION CHECK
# ============================================================
# Ensures commits are attributed to a registered agent, not "Claude"

check_agent_registered() {
    # Skip if not in a Claude Code session (no PPID-based session file)
    if [ ! -f "/tmp/claude-session-${PPID}.txt" ]; then
        return 0
    fi

    SESSION_ID=$(cat "/tmp/claude-session-${PPID}.txt" 2>/dev/null | tr -d '\n')
    if [ -z "$SESSION_ID" ]; then
        return 0
    fi

    # Check if agent file exists (check sessions/ first, then legacy location)
    AGENT_FILE=".claude/sessions/agent-${SESSION_ID}.txt"
    if [ ! -f "$AGENT_FILE" ]; then
        AGENT_FILE=".claude/agent-${SESSION_ID}.txt"
    fi
    if [ ! -f "$AGENT_FILE" ]; then
        echo "âŒ No agent registered for this session!" >&2
        echo "" >&2
        echo "Run /squad:start to register before committing." >&2
        echo "This ensures your work is properly tracked." >&2
        echo "" >&2
        echo "To skip this check: git commit --no-verify" >&2
        return 1
    fi

    AGENT_NAME=$(cat "$AGENT_FILE" 2>/dev/null | tr -d '\n')
    if [ -z "$AGENT_NAME" ] || [ "$AGENT_NAME" = "Claude" ]; then
        echo "âŒ Invalid agent registration ('$AGENT_NAME')!" >&2
        echo "" >&2
        echo "Run /squad:start to register properly." >&2
        return 1
    fi

    return 0
}

if ! check_agent_registered; then
    exit 1
fi

exit 0
